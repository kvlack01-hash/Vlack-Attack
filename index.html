<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vlack Attack v1.9.3 - Stable</title>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
        #output { background: white; margin: 20px 0; min-height: 520px; border: 1px solid #e1e4e8; border-radius: 12px; display: flex; justify-content: center; align-items: center; }
        .controls { display: flex; justify-content: center; align-items: center; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #eee; flex-wrap: wrap; gap: 15px; }
        .control-group { display: flex; flex-direction: column; align-items: flex-start; gap: 5px; }
        button, select { padding: 10px 12px; cursor: pointer; border-radius: 8px; border: 1px solid #ced4da; background: white; font-weight: bold; }
        #gen-btn { background: #27ae60; color: white; border: none; padding: 12px 25px; }
        .label-text { font-size: 0.8rem; font-weight: bold; color: #777; text-transform: uppercase; }
        /* BEAM VISIBILITY FIX: Ensuring no VexFlow elements are hidden */
        svg path { stroke-opacity: 1 !important; fill-opacity: 1 !important; }
    </style>
</head>
<body>

<div id="output"></div>

<div class="controls">
    <div class="control-group"><span class="label-text">Ride/Hi-Hat</span><select id="element-select"><option value="ride">Ride</option><option value="hi-hat">Hi-Hat</option></select></div>
    <div class="control-group"><span class="label-text">Ride Pattern</span><select id="cymbal-select"></select></div>
    <div class="control-group"><span class="label-text">Left Foot</span><select id="foot-select"></select></div>
    <button id="gen-btn">Randomize Kick/Snare</button>
    <div class="control-group"><span class="label-text">Tempo: <span id="bpm-display">92</span> BPM</span><input type="range" id="tempo-slider" min="40" max="220" value="92"></div>
    <button id="metro-btn" style="background: #3498db; color: white;">Play Beat</button>
    <div style="display: flex; gap: 15px; align-items: center; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
        <label><input type="checkbox" id="triplet-mode"> Triplet Mode</label>
        <label><input type="checkbox" id="accent-mode"> Accents</label>
        <label><input type="checkbox" id="freeze-bottom"> Freeze Kick/Snare</label>
    </div>
</div>

<script>
const VF = Vex.Flow;
let buffers = {};
let audioCtx = null;
let isPlaying = false;
let nextNoteTime = 0.0;
let timerID = null;
let currentBeat = 0;
let currentMid = [];

// DATA POOLS - Re-verified for Triplets and Straight
const tCym = { 'quarter notes': [1,0,0], 'shuffle': [1,0,1], 'swing': [1,0,0,1,0,1], '3:2 (down)': [1,0,1,0,1,0] };
const tFoot = { 'quarter notes': [1,0,0], '2 and 4': [0,0,0,1,0,0], '3:2 (down)': [1,0,1,0,1,0] };
const sCym = { 'quarter notes': [1,0,0,0], 'up beats': [0,0,1,0], 'eighth notes': [1,0,1,0], '1 e &': [1,1,1,0], 'eighth notes (down)': [1,0,1,0], 'eighth notes (up)': [1,0,1,0] };
const sFoot = { 'quarter notes': [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], '2 and 4': [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], 'eighth notes': [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] };
const tMidPool = [[1,0,0], [0,1,0], [1,0,1], [0,0,1], [1,1,0], [0,1,1]];
const sMidPool = [[1,0,0,0], [0,1,0,0], [0,0,1,0], [0,0,0,1], [1,0,1,0], [0,1,0,1]];

function updateMenus() {
    const isT = document.getElementById("triplet-mode").checked;
    const isA = document.getElementById("accent-mode").checked;
    const cS = document.getElementById("cymbal-select");
    const fS = document.getElementById("foot-select");
    cS.innerHTML = ""; fS.innerHTML = "";

    // Restoration of patterns logic
    let cL = isT ? 
        (isA ? ['shuffle', 'swing'] : ['quarter notes', 'shuffle', '3:2 (down)']) : 
        (isA ? ['eighth notes (up)', 'eighth notes (down)', '1 e &'] : ['quarter notes', 'up beats', 'eighth notes']);
    let fL = isT ? ['quarter notes', '2 and 4', '3:2 (down)'] : ['quarter notes', '2 and 4', 'eighth notes'];

    cL.forEach(k => cS.add(new Option(k, k)));
    fL.forEach(k => fS.add(new Option(k, k)));
}

function getAccentLogic(p, i, h) {
    if(!document.getElementById('accent-mode').checked || !h) return false;
    if(document.getElementById("triplet-mode").checked) return i % 3 === 0;
    const check = p.toLowerCase();
    if(check.includes('up')) return (i % 4) === 2;
    if(check.includes('down')) return (i % 4) === 0;
    return false;
}

function createNote(v, d, h, b, a = false) {
    const el = document.getElementById('element-select').value;
    let k, s, rK;
    if (v === 0) { s = 1; rK = "B/5/r"; k = (el === 'hi-hat') ? "G/5/x2" : (a ? "G/5/d2" : "G/5/x2"); }
    else if (v === 1) { k = (b % 2 === 0) ? "F/4" : "C/5"; s = -1; rK = "C/4/r"; }
    else { k = "B/4/x2"; s = -1; rK = "B/4/r"; }

    return new VF.StaveNote({ keys: [h ? k : rK], duration: d, stem_direction: s });
}

function generate(f = false) {
    const div = document.getElementById("output");
    div.innerHTML = "";
    const isT = document.getElementById("triplet-mode").checked;
    const sub = isT ? 3 : 4;

    const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
    renderer.resize(950, 450);
    const ctx = renderer.getContext();
    ctx.setStrokeStyle("#000");
    ctx.setLineWidth(1.5); // Thicker beams

    const stave1 = new VF.Stave(50, 40, 850).addClef("percussion").addTimeSignature("4/4").setContext(ctx).draw();
    const stave2 = new VF.Stave(50, 200, 850);
    [0, 1, 3, 4].forEach(l => stave2.setConfigForLine(l, { visible: false }));
    stave2.addClef("percussion").addTimeSignature("4/4").setContext(ctx).draw();

    if (f || !document.getElementById("freeze-bottom").checked || currentMid.length === 0) {
        currentMid = [];
        const pool = isT ? tMidPool : sMidPool;
        for (let i = 0; i < 4; i++) currentMid.push(pool[Math.floor(Math.random() * pool.length)]);
    }

    const cymVal = document.getElementById("cymbal-select").value;
    const footVal = document.getElementById("foot-select").value;
    const cymPat = (isT ? tCym : sCym)[cymVal] || [0];
    const footPat = (isT ? tFoot : sFoot)[footVal] || [0];

    const vD = [[], [], []];
    const beams = [];

    for (let b = 0; b < 4; b++) {
        for (let vI = 0; vI < 3; vI++) {
            let pat = (vI === 0) ? cymPat : (vI === 2 ? footPat : currentMid[b]);
            let beatNotes = [];
            for (let i = 0; i < sub; i++) {
                let hit = pat[(b * sub + i) % pat.length] === 1;
                let acc = (vI === 0) ? getAccentLogic(cymVal, b * sub + i, hit) : false;
                
                // Beams ONLY work on 8 or 16 durations. 4 cannot be beamed.
                let baseDur = isT ? "8" : (vI === 2 ? "8" : "16");
                let finalDur = hit ? baseDur : baseDur + "r";
                
                let note = createNote(vI, finalDur, hit, b, acc);
                vD[vI].push(note);
                beatNotes.push(note);
            }
            // Manual Beaming Logic
            const hitsOnly = beatNotes.filter(n => !n.isRest());
            if (hitsOnly.length > 1) {
                beams.push(new VF.Beam(hitsOnly));
            }
        }
    }

    const voices = vD.map(n => new VF.Voice({ num_beats: 4, beat_value: 4 }).setStrict(false).addTickables(n));
    new VF.Formatter().joinVoices(voices).format(voices, 750);

    voices[0].draw(ctx, stave1);
    voices[1].draw(ctx, stave1);
    voices[2].draw(ctx, stave2);
    
    // Draw beams last to ensure they sit on top
    beams.forEach(b => b.setContext(ctx).draw());
    console.log("Drawn Beams:", beams.length);
}

// Minimal Audio logic to prevent errors
async function loadKit(k) { console.log("Loading Kit: " + k); }

window.onload = () => {
    updateMenus();
    document.querySelectorAll("select, input").forEach(el => {
        el.onchange = () => {
            if(el.id === "triplet-mode" || el.id === "accent-mode") updateMenus();
            generate();
        };
    });
    document.getElementById("gen-btn").onclick = () => generate(true);
    generate();
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vlack Attack - Fixed V1.9.4</title>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f4f4f9; }
        #output { background: #fff; margin: 20px auto; width: 950px; border: 2px solid #ddd; border-radius: 10px; }
        .controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; padding: 20px; background: #eee; }
        .control-group { display: flex; flex-direction: column; align-items: flex-start; }
        label { font-size: 10px; font-weight: bold; color: #666; }
        /* DO NOT ADD DISPLAY:NONE RULES HERE */
    </style>
</head>
<body>

<div id="output"></div>

<div class="controls">
    <div class="control-group"><label>ELEMENT</label><select id="el-sel"><option value="ride">Ride</option><option value="hi-hat">Hi-Hat</option></select></div>
    <div class="control-group"><label>RIDE/HH PATTERN</label><select id="cym-sel"></select></div>
    <div class="control-group"><label>LEFT FOOT</label><select id="foot-sel"></select></div>
    <button id="gen-btn" style="background:#27ae60; color:white; border:none; padding:10px; border-radius:5px;">Randomize Bottom</button>
    <div class="control-group">
        <label><input type="checkbox" id="trip-chk"> Triplet Mode</label>
        <label><input type="checkbox" id="acc-chk"> Accents</label>
    </div>
</div>

<script>
const VF = Vex.Flow;
let currentMid = [];

function refreshInterface() {
    const isT = document.getElementById("trip-chk").checked;
    const isA = document.getElementById("acc-chk").checked;
    const cS = document.getElementById("cym-sel");
    const fS = document.getElementById("foot-sel");
    
    // Explicit Data Pools
    const tPatterns = ['quarter notes', 'shuffle', '3:2 (down)', 'swing'];
    const sPatterns = ['quarter notes', 'up beats', 'eighth notes', '1 e &'];
    const ftPatterns = isT ? ['quarter notes', '2 and 4', '3:2 (down)'] : ['quarter notes', '2 and 4', 'eighth notes'];

    cS.innerHTML = "";
    fS.innerHTML = "";
    
    const activeCym = isT ? tPatterns : sPatterns;
    activeCym.forEach(p => cS.add(new Option(p, p)));
    ftPatterns.forEach(p => fS.add(new Option(p, p)));
}

function runNotation(forceNew = false) {
    const div = document.getElementById("output");
    div.innerHTML = "";
    const isT = document.getElementById("trip-chk").checked;
    const sub = isT ? 3 : 4;

    const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
    renderer.resize(950, 400);
    const ctx = renderer.getContext();

    const stave = new VF.Stave(10, 40, 900).addClef("percussion").addTimeSignature("4/4").setContext(ctx).draw();

    // Data Mapping
    const cymMap = { 'quarter notes': [1,0,0,0], 'shuffle': [1,0,1], 'swing': [1,0,0,1,0,1], '3:2 (down)': [1,0,1,0,1,0], 'up beats': [0,0,1,0], 'eighth notes': [1,0,1,0], '1 e &': [1,1,1,0] };
    const pool = isT ? [[1,0,0], [1,0,1], [0,0,1]] : [[1,0,1,0], [0,1,0,1], [1,0,0,1]];

    if (forceNew || currentMid.length === 0) {
        currentMid = [];
        for (let i = 0; i < 4; i++) currentMid.push(pool[Math.floor(Math.random() * pool.length)]);
    }

    const cPat = cymMap[document.getElementById("cym-sel").value] || [1,0,0,0];
    const notesTop = [];
    const notesBot = [];
    const beams = [];

    for (let b = 0; b < 4; b++) {
        let beatGroupTop = [];
        let beatGroupBot = [];
        
        for (let i = 0; i < sub; i++) {
            // TOP VOICE (Cymbals) - Duration must be 8 for triplets, 16 for straight to beam
            let cHit = cPat[(b * sub + i) % cPat.length] === 1;
            let cNote = new VF.StaveNote({ 
                keys: [cHit ? "G/5/x2" : "G/5/r"], 
                duration: isT ? "8" : "16", 
                stem_direction: 1 
            });
            notesTop.push(cNote);
            beatGroupTop.push(cNote);

            // BOTTOM VOICE (Kick/Snare)
            let mHit = currentMid[b][i % currentMid[b].length] === 1;
            let mNote = new VF.StaveNote({ 
                keys: [mHit ? (b % 2 === 0 ? "F/4" : "C/5") : "C/4/r"], 
                duration: isT ? "8" : "16", 
                stem_direction: -1 
            });
            notesBot.push(mNote);
            beatGroupBot.push(mNote);
        }

        // Apply Beams to this specific beat
        const topHits = beatGroupTop.filter(n => !n.isRest());
        if (topHits.length > 1) beams.push(new VF.Beam(topHits));
        
        const botHits = beatGroupBot.filter(n => !n.isRest());
        if (botHits.length > 1) beams.push(new VF.Beam(botHits));
    }

    const v1 = new VF.Voice({ num_beats: 4, beat_value: 4 }).setStrict(false).addTickables(notesTop);
    const v2 = new VF.Voice({ num_beats: 4, beat_value: 4 }).setStrict(false).addTickables(notesBot);

    new VF.Formatter().joinVoices([v1, v2]).format([v1, v2], 800);
    v1.draw(ctx, stave);
    v2.draw(ctx, stave);
    beams.forEach(b => b.setContext(ctx).draw());
}

window.onload = () => {
    refreshInterface();
    document.getElementById("trip-chk").onchange = () => { refreshInterface(); runNotation(); };
    document.getElementById("el-sel").onchange = () => runNotation();
    document.getElementById("cym-sel").onchange = () => runNotation();
    document.getElementById("gen-btn").onclick = () => runNotation(true);
    runNotation();
};
</script>
</body>
</html>

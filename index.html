<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vlack Attack v1.9.3</title>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
        #output { background: white; margin: 20px 0; min-height: 520px; border: 1px solid #e1e4e8; border-radius: 12px; display: flex; justify-content: center; align-items: center; overflow-x: auto; }
        .controls { display: flex; justify-content: center; align-items: center; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #eee; flex-wrap: wrap; gap: 15px; }
        .control-group { display: flex; flex-direction: column; align-items: flex-start; gap: 5px; }
        button, select { padding: 10px 12px; cursor: pointer; border-radius: 8px; border: 1px solid #ced4da; background: white; font-weight: bold; }
        #gen-btn { background: #27ae60; color: white; border: none; padding: 12px 25px; }
        .label-text { font-size: 0.8rem; font-weight: bold; color: #777; text-transform: uppercase; }
        /* BEAMS FIXED: Removed .vf-flag display none */
    </style>
</head>
<body>

<div id="output"></div>

<div class="controls">
    <div class="control-group"><span class="label-text">Ride/Hi-Hat</span><select id="element-select"><option value="ride">Ride</option><option value="hi-hat">Hi-Hat</option></select></div>
    <div class="control-group"><span class="label-text">Ride Pattern</span><select id="cymbal-select"></select></div>
    <div class="control-group"><span class="label-text">Left Foot</span><select id="foot-select"></select></div>
    <button id="gen-btn">Randomize Kick/Snare</button>
    <div class="control-group"><span class="label-text">Tempo: <span id="bpm-display">92</span> BPM</span><input type="range" id="tempo-slider" min="40" max="220" value="92"></div>
    <div class="control-group"><span class="label-text">Drum Kit</span><select id="kit-select"><option value="studio">Studio</option><option value="jazz">Jazz</option><option value="lo-fi">Lo-Fi</option><option value="muffled">Muffled</option><option value="boomy">Boomy</option><option value="compressed">Compressed</option></select></div>
    <button id="metro-btn" style="background: #3498db; color: white;">Play Beat</button>
    <div style="display: flex; gap: 15px; align-items: center; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
        <label><input type="checkbox" id="triplet-mode"> Triplet Mode</label>
        <label><input type="checkbox" id="accent-mode"> Accents</label>
        <label><input type="checkbox" id="freeze-bottom"> Freeze Kick/Snare</label>
    </div>
</div>

<script>
const VF = Vex.Flow;
let buffers = {};
let audioCtx = null;
let isPlaying = false;
let nextNoteTime = 0.0;
let timerID = null;
let currentBeat = 0;
let currentMid = [];

// DATA POOLS
const tCym = { 'quarter notes': [1,0,0], 'shuffle': [1,0,1], 'swing': [1,0,0,1,0,1], '3:2 (down)': [1,0,1,0,1,0] };
const tFoot = { 'quarter notes': [1,0,0], '2 and 4': [0,0,0,1,0,0], '3:2 (down)': [1,0,1,0,1,0] };
const sCym = { 'quarter notes': [1,0,0,0], 'up beats': [0,0,1,0], 'eighth notes': [1,0,1,0], '1 e &': [1,1,1,0], 'eighth notes (down)': [1,0,1,0], 'eighth notes (up)': [1,0,1,0] };
const sFoot = { 'quarter notes': [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], '2 and 4': [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], 'eighth notes': [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] };
const tMidPool = [[1,0,0], [0,1,0], [1,0,1], [0,0,1], [1,1,0], [0,1,1]];
const sMidPool = [[1,0,0,0], [0,1,0,0], [0,0,1,0], [0,0,0,1], [1,0,1,0], [0,1,0,1]];

function updateMenus() {
    const isT = document.getElementById("triplet-mode").checked;
    const isA = document.getElementById("accent-mode").checked;
    const cS = document.getElementById("cymbal-select");
    const fS = document.getElementById("foot-select");
    cS.innerHTML = ""; fS.innerHTML = "";

    let cL = isT ? 
        (isA ? ['shuffle', 'swing'] : ['quarter notes', 'shuffle', '3:2 (down)']) : 
        (isA ? ['eighth notes (up)', 'eighth notes (down)', '1 e &'] : ['quarter notes', 'up beats', 'eighth notes']);
    let fL = isT ? ['quarter notes', '2 and 4', '3:2 (down)'] : ['quarter notes', '2 and 4', 'eighth notes'];

    cL.forEach(k => cS.add(new Option(k, k)));
    fL.forEach(k => fS.add(new Option(k, k)));
}

function getAccentLogic(p, i, h) {
    if(!document.getElementById('accent-mode').checked || !h) return false;
    if(document.getElementById("triplet-mode").checked) return i % 3 === 0;
    const check = p.toLowerCase();
    if(check.includes('up')) return (i % 4) === 2;
    if(check.includes('down')) return (i % 4) === 0;
    return false;
}

function createNote(v, d, h, b, a = false) {
    const el = document.getElementById('element-select').value;
    let k, s, rK;
    if (v === 0) { 
        s = 1; rK = "B/5/r"; 
        k = (el === 'hi-hat') ? "G/5/x2" : (a ? "G/5/d2" : "G/5/x2"); 
    } else if (v === 1) { 
        k = (b % 2 === 0) ? "F/4" : "C/5"; 
        s = -1; rK = "C/4/r"; 
    } else { 
        k = "B/4/x2"; s = -1; rK = "B/4/r"; 
    }
    const note = new VF.StaveNote({ keys: [h ? k : rK], duration: d, stem_direction: s });
    if (h && v === 0 && a && el === 'hi-hat') note.addModifier(new VF.Articulation('ah').setPosition(3), 0);
    if (v === 2) note.setKeyLine(0, 2);
    return note;
}

function generate(f = false) {
    const div = document.getElementById("output");
    div.innerHTML = "";
    const isT = document.getElementById("triplet-mode").checked;
    const sub = isT ? 3 : 4;

    const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
    renderer.resize(950, 450);
    const ctx = renderer.getContext();
    ctx.setStrokeStyle("#000");
    ctx.setLineWidth(1.2);

    const stave1 = new VF.Stave(50, 40, 850).addClef("percussion").addTimeSignature("4/4").setContext(ctx).draw();
    const stave2 = new VF.Stave(50, 200, 850);
    [0, 1, 3, 4].forEach(l => stave2.setConfigForLine(l, { visible: false }));
    stave2.addClef("percussion").addTimeSignature("4/4").setContext(ctx).draw();

    if (f || !document.getElementById("freeze-bottom").checked || currentMid.length === 0) {
        currentMid = [];
        const pool = isT ? tMidPool : sMidPool;
        for (let i = 0; i < 4; i++) currentMid.push(pool[Math.floor(Math.random() * pool.length)]);
    }

    const cymVal = document.getElementById("cymbal-select").value;
    const footVal = document.getElementById("foot-select").value;
    const cymPat = (isT ? tCym : sCym)[cymVal] || [0];
    const footPat = (isT ? tFoot : sFoot)[footVal] || [0];

    const vD = [[], [], []];
    const beams = [];

    for (let b = 0; b < 4; b++) {
        for (let vI = 0; vI < 3; vI++) {
            let pat = (vI === 0) ? cymPat : (vI === 2 ? footPat : currentMid[b]);
            let beatNotes = [];
            for (let i = 0; i < sub; i++) {
                let hit = pat[(b * sub + i) % pat.length] === 1;
                let acc = (vI === 0) ? getAccentLogic(cymVal, b * sub + i, hit) : false;
                let baseDur = isT ? "8" : (vI === 2 ? "8" : "16");
                let finalDur = hit ? baseDur : baseDur + "r";
                let note = createNote(vI, finalDur, hit, b, acc);
                vD[vI].push(note);
                beatNotes.push(note);
            }
            const hitsOnly = beatNotes.filter(n => !n.isRest());
            if (hitsOnly.length > 1) {
                beams.push(new VF.Beam(hitsOnly));
            }
        }
    }

    const voices = vD.map(n => new VF.Voice({ num_beats: 4, beat_value: 4 }).setStrict(false).addTickables(n));
    new VF.Formatter().joinVoices(voices).format(voices, 750);

    voices[0].draw(ctx, stave1);
    voices[1].draw(ctx, stave1);
    voices[2].draw(ctx, stave2);
    beams.forEach(b => b.setContext(ctx).draw());
}

// AUDIO ENGINE
async function loadKit(k) {
    const sounds = ['kick','snare','hihat','hihat_open','hihat_foot','ride','ride_bell'];
    for (const name of sounds) {
        try {
            const r = await fetch(`samples/${k}/${name}.wav`);
            if(!r.ok) throw new Error();
            const ab = await r.arrayBuffer();
            buffers[name] = await audioCtx.decodeAudioData(ab);
        } catch(e) { console.warn("Using synth for " + name); }
    }
}

function playDrum(n, t, isAcc = false) {
    if(!audioCtx) return;
    let sN = (isAcc && n === 'ride') ? 'ride_bell' : (isAcc && n === 'hihat' ? 'hihat_open' : n);
    if(buffers[sN]) {
        const s = audioCtx.createBufferSource();
        s.buffer = buffers[sN];
        s.connect(audioCtx.destination);
        s.start(t);
    } else {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.connect(g).connect(audioCtx.destination);
        g.gain.setValueAtTime(0.05, t);
        g.gain.exponentialRampToValueAtTime(0.001, t+0.05);
        osc.start(t); osc.stop(t+0.05);
    }
}

function scheduler() {
    const tempo = document.getElementById('tempo-slider').value;
    const isT = document.getElementById("triplet-mode").checked;
    const sps = isT ? (60/tempo/3) : (60/tempo/4);
    while (nextNoteTime < audioCtx.currentTime + 0.1) {
        const cN = document.getElementById("cymbal-select").value;
        const fN = document.getElementById("foot-select").value;
        const el = document.getElementById('element-select').value;
        const cP = (isT?tCym:sCym)[cN];
        const fP = (isT?tFoot:sFoot)[fN];

        if(cP && cP[currentBeat % cP.length] === 1) playDrum(el==='hi-hat'?'hihat':el, nextNoteTime, getAccentLogic(cN, currentBeat, true));
        const bI = Math.floor(currentBeat/(isT?3:4));
        if(currentMid[bI] && currentMid[bI][currentBeat%(isT?3:4)] === 1) playDrum(bI%2===0 ? 'kick' : 'snare', nextNoteTime);
        if(fP && fP[currentBeat % fP.length] === 1) playDrum('hihat_foot', nextNoteTime);

        nextNoteTime += sps;
        currentBeat = (currentBeat + 1) % (isT ? 12 : 16);
    }
    timerID = setTimeout(scheduler, 25);
}

window.onload = () => {
    updateMenus();
    document.querySelectorAll("select, input").forEach(el => {
        el.onchange = () => {
            if(el.id === "triplet-mode" || el.id === "accent-mode") updateMenus();
            generate();
        };
    });
    document.getElementById("gen-btn").onclick = () => generate(true);
    document.getElementById('tempo-slider').oninput = (e) => document.getElementById('bpm-display').innerText = e.target.value;
    document.getElementById('metro-btn').onclick = async function() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        if (Object.keys(buffers).length === 0) await loadKit(document.getElementById('kit-select').value);
        isPlaying = !isPlaying;
        if (isPlaying) { currentBeat = 0; nextNoteTime = audioCtx.currentTime; scheduler(); this.innerText = "Stop"; }
        else { clearTimeout(timerID); this.innerText = "Play Beat"; }
    };
    generate();
};
</script>
</body>
</html>

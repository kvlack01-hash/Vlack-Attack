<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vlack Attack Beat Randomizer</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Drum beat pattern randomizer and practice tool">
    <meta name="theme-color" content="#F79256">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vlack Attack">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --warm-orange: #F79256;
            --warm-peach: #FBD1A2;
            --warm-mint: #7DCFB6;
            --warm-cyan: #00B2CA;
            --warm-blue: #1D4E89;
        }

        

        body { 
            font-family: 'Montserrat', sans-serif;
            background: #000;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #fff;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #000;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: var(--warm-orange);
            padding: 15px 15px 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0,0,0,0.03) 2px,
                    rgba(0,0,0,0.03) 4px
                );
            pointer-events: none;
        }
        
        .header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: 4px;
            margin-bottom: 2px;
            color: #000; text-shadow: 0 0 10px rgba(0,0,0,0.5);
            text-shadow: 2px 2px 0 rgba(255,255,255,0.3);
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #000; text-shadow: 0 0 10px rgba(0,0,0,0.5);
            opacity: 0.8;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
        
        /* Notation Display */
        #output {
            background: #fff;
            padding: 3px;
            min-height: 180px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: auto;
            border-bottom: 3px solid var(--warm-mint);
        }
        
        /* Controls Container */
        .controls {
            padding: 12px;
        }
        
        /* Randomize Button - Centered */
        .randomize-section {
            margin-bottom: 20px;
        }
        
        .big-btn {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.85rem;
            letter-spacing: 1.5px;
            cursor: pointer;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }
        
        .big-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .big-btn:active::before {
            left: 100%;
        }
        
        .big-btn:active {
            transform: scale(0.98);
        }
        
        .big-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: var(--warm-blue) !important;
            color: #666 !important;
        }
        
        .randomize-btn {
            background: var(--warm-mint);
            color: #000;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(185, 241, 140, 0.4);
        }
        
        /* Kit and Play Row */
        .kit-play-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .kit-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .kit-label {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--warm-peach);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select {
            padding: 10px 8px;
            border: 2px solid var(--warm-blue);
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.65rem;
            font-weight: 700;
            background: rgba(28, 2, 33, 0.5);
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        select:focus {
            outline: none;
            border-color: var(--warm-orange);
        }
        
        select:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: #111;
        }
        
        .play-btn {
            background: var(--warm-orange);
            color: #000;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(233, 235, 135, 0.4);
        }
        
        /* Sliders Section */
        .sliders-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--warm-blue);
        }
        
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .slider-group label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--warm-peach);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .slider-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--warm-orange);
        }
        
        .slider-group input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(28, 2, 33, 0.5);
            border: 2px solid var(--warm-blue);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }
        
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--warm-orange);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(233, 235, 135, 0.5);
            transition: all 0.2s;
        }
        
        .slider-group input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.2);
        }
        
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--warm-orange);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(233, 235, 135, 0.5);
        }
        
        .slider-group input[type="range"]:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Toggle Row */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--warm-blue);
        }
        
        /* Select Buttons */
        .select-buttons {
            display: flex;
            gap: 8px;
        }
        
        .select-btn {
            padding: 8px 14px;
            border: 2px solid var(--warm-blue);
            background: rgba(28, 2, 33, 0.5);
            color: #ccc;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .select-btn.active {
            background: var(--warm-mint);
            border-color: var(--warm-mint);
            color: #000;
            box-shadow: 0 4px 12px rgba(185, 241, 140, 0.3);
        }
        
        .select-btn:active {
            transform: scale(0.95);
        }
        
        
        /* Section */
        .section {
            margin-bottom: 10px;
            padding: 12px;
            background: rgba(123, 94, 123, 0.1);
            border-radius: 10px;
            border: 2px solid var(--warm-blue);
        }
        
        .section-title {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--warm-orange);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .section-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        
        .section-left {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .section-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Accent Toggle */
        .accent-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 8px;
            background: transparent;
            border-radius: 8px;
            border: none;
            transition: all 0.2s;
        }
        
        .accent-toggle:has(input:checked) {
            background: transparent;
        }
        
        .accent-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--warm-mint);
        }
        
        .accent-toggle label {
            font-weight: 700;
            color: #ccc;
            cursor: pointer;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Save/Load Section */
        .save-section {
            padding: 12px;
            background: rgba(28, 2, 33, 0.5);
            border-radius: 10px;
            border: 2px solid var(--warm-blue);
            margin-bottom: 10px;
        }
        
        .save-load-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .save-btn {
            background: var(--warm-blue);
            color: #fff;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(147, 130, 116, 0.4);
        }
        
        /* Text Buttons */
        .text-buttons {
            display: flex;
            justify-content: space-between;
            padding-top: 8px;
            border-top: 1px solid var(--warm-blue);
        }
        
        .text-btn {
            background: none;
            border: none;
            color: var(--warm-mint);
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.6rem;
            cursor: pointer;
            text-decoration: none;
            padding: 6px 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        
        .text-btn:active {
            opacity: 0.6;
            transform: scale(0.95);
        }
        
        .vf-flag { display: none !important; }
        
        /* Save Dialog */
        .save-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .save-dialog.active {
            display: flex;
        }
        
        .save-dialog-content {
            background: var(--warm-blue);
            padding: 30px;
            border-radius: 15px;
            border: 3px solid var(--warm-cyan);
            box-shadow: 0 0 30px var(--warm-cyan);
            max-width: 400px;
            width: 90%;
        }
        
        .save-dialog h3 {
            margin: 0 0 20px 0;
            color: var(--warm-orange);
            font-size: 1.5rem;
        }
        
        .save-dialog input {
            width: 100%;
            padding: 12px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            border: 2px solid var(--warm-mint);
            border-radius: 8px;
            background: #000;
            color: #fff;
            margin-bottom: 20px;
        }
        
        .save-dialog-buttons {
            display: flex;
            gap: 10px;
        }
        
        .save-dialog-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            text-transform: uppercase;
        }
        
        .save-dialog-confirm {
            background: var(--warm-mint);
            color: #000;
        }
        
        .save-dialog-cancel {
            background: #333;
            color: #fff;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section, .save-section {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Mobile optimizations */
        @media (max-width: 600px) {
            .header h1 { font-size: 2.8rem; }
            .big-btn { font-size: 1.3rem; padding: 18px; }
            #output { padding: 15px; }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <div class="header">
        <div style="font-family: 'Montserrat', sans-serif; font-size: 2.5rem; line-height: 1.2; color: #000; font-weight: 800; letter-spacing: 2px;">
            Vlack Attack
        </div>
        <div style="font-family: 'Montserrat', sans-serif; font-size: 1.2rem; color: #000; margin-top: 5px; font-weight: 600; letter-spacing: 1px;">
            Beat Randomizer
        </div>
    </div>
    </div>
    
    <!-- Notation Display -->
    <div id="output"></div>
    
    <!-- Controls -->
    <div class="controls">
        <!-- Randomize Button & Lock -->
        <div class="randomize-section">
            <button class="big-btn randomize-btn" id="gen-btn" style="width: 100%;">‚ö° Randomize Kick/Snare</button>
        </div>
        
        <!-- Drum Kit & Play Button Row -->
        <div class="kit-play-row">
            <div class="kit-group">
                <div class="kit-label">Drum Kit</div>
                <select id="kit-select">
                    <option value="studio">Studio</option>
                    <option value="jazz">Jazz</option>
                    <option value="lo-fi">Lo-Fi</option>
                    <option value="muffled">Muffled</option>
                    <option value="boomy">Boomy</option>
                    <option value="metal">Metal</option>
                </select>
            </div>
            <button class="big-btn play-btn" id="metro-btn">‚ñ∂ Play Beat</button>
        </div>
        
        <!-- Sliders -->
        <div class="sliders-section">
            <div class="slider-group">
                <label>
                    <span>Tempo</span>
                    <span class="slider-value"><span id="bpm-display">90</span> BPM</span>
                </label>
                <input type="range" id="tempo-slider" min="40" max="220" value="90">
            </div>
            <div class="slider-group">
                <label>
                    <span>Pocket</span>
                    <span class="slider-value"><span id="pocket-display">0</span>%</span>
                </label>
                <input type="range" id="pocket-slider" min="0" max="30" value="0">
            </div>
        </div>
        
        <!-- Toggle Row: Triplet/Straight -->
        <div class="toggle-row">
            <div class="select-buttons">
                <button class="select-btn active" data-mode="straight">Straight</button>
                <button class="select-btn" data-mode="triplet">Triplet</button>
            </div>
        </div>
        
        <!-- Right Hand & Left Foot Row -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <!-- Right Hand Section -->
            <div class="section" style="margin-bottom: 0;">
                <div class="section-title">‚Üí Right Hand</div>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="select-buttons">
                        <button class="select-btn" data-element="ride">Ride</button>
                        <button class="select-btn active" data-element="hi-hat">Hi-Hat</button>
                    </div>
                    <div class="accent-toggle">
                        <input type="checkbox" id="accent-mode">
                        <label for="accent-mode">Accents</label>
                    </div>
                    <div>
                        <div style="font-size: 0.65rem; font-weight: 700; color: var(--warm-peach); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Pattern</div>
                        <select id="cymbal-select"></select>
                    </div>
                </div>
            </div>
            
            <!-- Left Foot Section -->
            <div class="section" style="margin-bottom: 0;">
                <div class="section-title">‚Üê Left Foot</div>
                <div class="section-content">
                    <div style="width: 100%;">
                        <div style="font-size: 0.65rem; font-weight: 700; color: var(--warm-peach); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Pattern</div>
                        <select id="foot-select"></select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save/Load Section -->
        <div class="save-section">
            <div class="save-load-row">
                <button class="big-btn save-btn" id="save-btn">üíæ Save Beat</button>
                <select id="saved-beats-select">
                    <option value="">-- Select a Beat --</option>
                </select>
            </div>
            <div class="text-buttons">
                <button class="text-btn" id="delete-btn">Delete</button>
                <button class="text-btn" id="rename-btn">Rename</button>
            </div>
        </div>
    </div>
</div>

<!-- Save Dialog -->
<div id="save-dialog" class="save-dialog">
    <div class="save-dialog-content">
        <h3>Save Beat</h3>
        <input type="text" id="save-name-input" placeholder="Enter beat name...">
        <div class="save-dialog-buttons">
            <button class="save-dialog-cancel" id="save-cancel">Cancel</button>
            <button class="save-dialog-confirm" id="save-confirm">Save</button>
        </div>
    </div>
</div>

<script>
const VF = Vex.Flow;

// --- GLOBAL STATE ---
let audioCtx = null;
let buffers = {};
let isPlaying = false;
let currentBeat = 0;
let nextNoteTime = 0.0;
let timerID = null;
let currentMid = [];
let activeHH = null;

// --- RHYTHM DATA ---
const tCymPlain = ['Down Beats', 'Shuffle', 'Swing', '3:2 (Down)', '3:2 (Up)', '3:4 V1', '3:4 V2', '3:4 V3'];
const tCymAcc = ['Shuffle', 'Swing', '3:2 (Down)', '3:2 (Up)', '3:2 (Down) Shuffle', '3:2 (Up) Shuffle', '3:4 V1', '3:4 V2', '3:4 V3'];
const tCym = { 
    'Down Beats': [1,0,0], 'Shuffle': [1,0,1], 'Swing': [1,0,0,1,0,1],
    '3:2 (Down)': [1,0,1,0,1,0, 1,0,1,0,1,0], '3:2 (Up)': [0,1,0,1,0,1, 0,1,0,1,0,1],
    '3:4 V1': [1,1,1,0,1,1,1,0,1,1,1,0], '3:4 V2': [1,0,1,1,1,0,1,1,1,0,1,1], '3:4 V3': [0,1,1,1,0,1,1,1,0,1,1,1],
    '3:2 (Down) Shuffle': [1,0,1,0,1,0], '3:2 (Up) Shuffle': [0,1,0,1,0,1]
};
const tFoot = { 'Down Beats': [1,0,0], '2 and 4': [0,0,0,1,0,0], '3:2 (Down)': [1,0,1,0,1,0], '3:2 (Up)': [0,1,0,1,0,1] };
const sCymPlain = ['Down Beats', 'Up Beats', 'Eighth Notes', 'E A', '1 E &', 'E & A', '1 & A', '1 E A'];
const sCymAcc = ['Down Beats', 'Up Beats', '1 E &', 'E & A', '1 & A', '1 E A'];
const sCym = {
    'Down Beats': [1,0,0,0], 'Up Beats': [0,0,1,0], 'Eighth Notes': [1,0,1,0],
    'E A': [0,1,0,1], '1 E &': [1,1,1,0], 'E & A': [0,1,1,1],
    '1 & A': [1,0,1,1], '1 E A': [1,1,0,1]
};
const sFoot = { 'Down Beats': [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0], '2 and 4': [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0], 'Eighth Notes': [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0] };
const tMidPool = [[1,0,0], [0,1,0], [1,0,1], [0,0,1], [1,1,0], [0,1,1]];
const sMidPool = [[1,0,0,0], [0,1,0,0], [0,0,1,0], [0,0,0,1], [1,0,1,0], [0,1,0,1], [1,1,0,0], [0,1,1,0], [0,0,1,1], [1,0,0,1], [1,1,1,0], [0,1,1,1], [1,0,1,1], [1,1,0,1]];

function getFootPatternForHiHatAccents(cymbalPattern, isTriplet = false) {
    if (isTriplet) {
        const tripletFootPatterns = {
            'Shuffle': [0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0],
            'Swing': [0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0],
            '3:2 (Down)': [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
            '3:2 (Up)': [0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1],
            '3:2 (Down) Shuffle': [0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0],
            '3:2 (Up) Shuffle': [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1],
            '3:4 V1': [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
            '3:4 V2': [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
            '3:4 V3': [0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0]
        };
        return tripletFootPatterns[cymbalPattern] || null;
    } else {
        const standardFootPatterns = {
            'Down Beats': [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
            'Up Beats': [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
            '1 E &': [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
            'E & A': [0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0],
            '1 & A': [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
            '1 E A': [0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1]
        };
        return standardFootPatterns[cymbalPattern] || null;
    }
}

function getAccentLogic(patternName, index, isHit) {
    if (!document.getElementById('accent-mode').checked || !isHit) return false;
    const isTri = isTripletMode();
    if (isTri) {
        const pos3 = index % 3, pos6 = index % 6, pos12 = index % 12;
        switch(patternName) {
            case 'Shuffle': return pos3 === 0;
            case 'Swing': return pos6 === 0;
            case '3:2 (Down)': return (pos12 === 0 || pos12 === 4 || pos12 === 8);
            case '3:2 (Up)': return (pos12 === 3 || pos12 === 7 || pos12 === 11);
            case '3:2 (Down) Shuffle': return (pos6 === 0 || pos6 === 4);
            case '3:2 (Up) Shuffle': return (pos6 === 1 || pos6 === 3);
            case '3:4 V1': return (pos12 === 2 || pos12 === 6 || pos12 === 10);
            case '3:4 V2': return (pos12 === 0 || pos12 === 4 || pos12 === 8);
            case '3:4 V3': return (pos12 === 3 || pos12 === 7 || pos12 === 11);
            default: return false;
        }
    } else {
        const pos = index % 4;
        switch(patternName) {
            case 'Down Beats': return pos === 0;
            case 'Up Beats': return pos === 2;
            case '1 E &': return pos === 2;
            case 'E & A': return pos === 3;
            case '1 & A': return pos === 0;
            case '1 E A': return pos === 1;
            default: return false;
        }
    }
}

function isTripletMode() {
    return document.querySelector('[data-mode="triplet"]').classList.contains('active');
}

function getElement() {
    return document.querySelector('[data-element].active').dataset.element;
}

function updateFootPatternForHiHatAccents() {
    const isAccent = document.getElementById("accent-mode").checked;
    const element = getElement();
    const fSel = document.getElementById("foot-select");
    
    if (isAccent && element === 'hi-hat') {
        fSel.disabled = true;
    } else {
        fSel.disabled = false;
    }
}

function updateMenus() {
    const isTri = isTripletMode();
    const isAcc = document.getElementById("accent-mode").checked;
    const cSel = document.getElementById("cymbal-select");
    const previousCymbal = cSel.value;
    const fSel = document.getElementById("foot-select");
    const previousFoot = fSel.value;

    cSel.innerHTML = "";
    let cymList = isTri ? (isAcc ? tCymAcc : tCymPlain) : (isAcc ? sCymAcc : sCymPlain);
    cymList.forEach(k => { 
        let o = document.createElement("option"); o.value = k; o.text = k.trim(); cSel.add(o); 
    });
    cSel.value = Array.from(cSel.options).some(opt => opt.value === previousCymbal) ? previousCymbal : cSel.options[0].value;

    fSel.innerHTML = "";
    let fList = isTri ? Object.keys(tFoot) : Object.keys(sFoot);
    fList.forEach(k => { 
        let o = document.createElement("option"); o.value = k; o.text = k; fSel.add(o); 
    });
    fSel.value = Array.from(fSel.options).some(opt => opt.value === previousFoot) ? previousFoot : fSel.options[0].value;
    
    updateFootPatternForHiHatAccents();
}

function createNote(vIdx, dur, isHit, bIdx, isAcc = false) {
    let key, stem, restKey;
    const element = getElement();
    let cleanDur = dur.replace('r', '');
    let actualRest = !isHit || dur.includes('r');

    if (vIdx === 0) {
        stem = 1; 
        restKey = "G/5/r";
        key = "G/5/x2";
        if (isHit && !actualRest) {
            key = (element === 'hi-hat') ? "G/5/x2" : (isAcc ? "G/5/d2" : "G/5/x2");
        }
    } else if (vIdx === 1) {
        key = (bIdx % 2 === 0) ? "F/4" : "C/5"; 
        stem = -1; 
        restKey = (bIdx % 2 === 0) ? "F/4/r" : "C/5/r";
    } else {
        key = "B/4/x2"; 
        stem = -1; 
        restKey = "B/4/r";
    }

    const note = new VF.StaveNote({ 
        keys: [actualRest ? restKey : key], 
        duration: cleanDur + (actualRest ? "r" : ""), 
        stem_direction: stem 
    });

    if (isHit && vIdx === 0 && isAcc && element === 'hi-hat' && !actualRest) {
        note.addModifier(new VF.Articulation('ah').setPosition(3), 0);
    }
    if (cleanDur.includes('d')) VF.Dot.buildAndAttach([note], { all: true });
    
    if (vIdx === 2) {
        note.setKeyLine(0, 2);
    }
    
    return note;
}

function generate(forceRandom = false) {
    const div = document.getElementById("output");
    div.innerHTML = "";
    const isTri = isTripletMode();
    const sub = isTri ? 3 : 4;
    const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
    renderer.resize(1000, 350);
    const ctx = renderer.getContext();
    const s1 = new VF.Stave(80, 40, 870).addClef("percussion").addTimeSignature("4/4").setContext(ctx).draw();
    const s2 = new VF.Stave(80, 190, 870);
    [0, 1, 3, 4].forEach(line => s2.setConfigForLine(line, { visible: false }));
    s2.addClef("percussion").addTimeSignature("4/4").setContext(ctx).draw();
    new VF.StaveConnector(s1, s2).setType(VF.StaveConnector.type.BRACKET).setContext(ctx).draw();

    if (forceRandom || currentMid.length === 0) {
        currentMid = [];
        const pool = isTri ? tMidPool : sMidPool;
        for (let i = 0; i < 4; i++) currentMid.push(pool[Math.floor(Math.random() * pool.length)]);
    }

    const vData = [[], [], []], beams = [];
    const cymName = document.getElementById("cymbal-select").value;
    const footName = document.getElementById("foot-select").value;
    const isAccent = document.getElementById("accent-mode").checked;
    const element = getElement();
    
    let customFootPattern = null;
    if (isAccent && element === 'hi-hat') {
        customFootPattern = getFootPatternForHiHatAccents(cymName, isTri);
    }

    for (let b = 0; b < 4; b++) {
        for (let vIdx = 0; vIdx < 3; vIdx++) {
            let slice = [], pat;
            
            if (vIdx === 0) {
                pat = (isTri ? tCym : sCym)[cymName];
            } else if (vIdx === 2) {
                if (customFootPattern) {
                    pat = customFootPattern;
                } else {
                    pat = (isTri ? tFoot : sFoot)[footName];
                }
            } else {
                pat = currentMid[b];
            }
            
            if (vIdx === 0 && document.getElementById('accent-mode').checked && !isTri) {
                if (cymName === 'Down Beats' || cymName === 'Up Beats') pat = [1, 0, 1, 0];
            }
            for (let i = 0; i < sub; i++) slice.push(pat[(b * sub + i) % pat.length]);
            
            let isFullBeat = slice.slice(1).every(v => v === 0);
            if (isFullBeat) {
                let cDur = isTri ? "4d" : "4", hit = slice[0] === 1, acc = (vIdx === 0) ? getAccentLogic(cymName, b * sub, hit) : false;
                vData[vIdx].push(createNote(vIdx, cDur, hit, b, acc));
            } else {
                let bNotes = [];
                for (let i = 0; i < sub; i++) {
                    let hit = slice[i] === 1, acc = (vIdx === 0) ? getAccentLogic(cymName, b * sub + i, hit) : false, finalDur = isTri ? "8" : "16";
                    if (!isTri) {
                        let empty = 0; for (let j = i+1; j < sub; j++) if (slice[j] === 0) empty++; else break;
                        if (hit) { if (empty === 1) { finalDur = "8"; i+=1; } else if (empty === 2) { finalDur = "8d"; i+=2; } else if (empty === 3) { finalDur = "4"; i+=3; } }
                        else { if (empty === 1) { finalDur = "8r"; i+=1; } else if (empty === 2) { finalDur = "8dr"; i+=2; } else if (empty === 3) { finalDur = "4r"; i+=3; } else finalDur = "16r"; }
                    } else if (!hit) finalDur = "8r";
                    let n = createNote(vIdx, finalDur, hit, b, acc);
                    bNotes.push(n); vData[vIdx].push(n);
                }
                let nBeam = isTri ? bNotes : bNotes.filter(n => !n.isRest());
                if (nBeam.length >= 2) beams.push(new VF.Beam(nBeam));
            }
        }
    }
    const voices = vData.map(notes => new VF.Voice({num_beats: sub*4, beat_value: isTri ? 8 : 16}).setStrict(false).addTickables(notes));
    new VF.Formatter().joinVoices(voices.slice(0,2)).format(voices.slice(0,2), 800);
    new VF.Formatter().joinVoices([voices[2]]).format([voices[2]], 800);
    voices[0].draw(ctx, s1); voices[1].draw(ctx, s1); voices[2].draw(ctx, s2);
    beams.forEach(b => b.setContext(ctx).draw());
}

// --- AUDIO ENGINE ---
async function loadKit(kitName) {
    const names = ['kick', 'snare', 'hihat', 'hihat_open', 'hihat_foot', 'ride', 'ride_bell'];
    const newBuffers = {};
    console.log(`--- Loading Kit: ${kitName} ---`);
    for (const name of names) {
        try {
            const resp = await fetch(`samples/${kitName}/${name}.wav`);
            if (resp.ok) newBuffers[name] = await audioCtx.decodeAudioData(await resp.arrayBuffer());
        } catch (e) { console.error("Load error:", name, e); }
    }
    buffers = newBuffers;
    console.log("--- Kit Ready ---");
}

function playDrum(name, time, isAcc = false) {
    if (!audioCtx) return;
    let id = name;
    if (isAcc) { 
        if(name==='ride') id='ride_bell'; 
        if(name==='hihat') id='hihat_open'; 
    }
    
    // Try to play from loaded buffer
    if (buffers[id]) {
        try {
            const source = audioCtx.createBufferSource();
            const gainNode = audioCtx.createGain();
            source.buffer = buffers[id];

            let gainValue = 1.0;
            if (id.includes('hihat') || id.includes('ride')) {
                gainValue = 0.4;
            }
            gainNode.gain.value = gainValue;

            const isHiHat = id.includes('hihat');
            
            if (isHiHat) {
                if (activeHH) {
                    try {
                        const isOpeningHit = id === 'hihat_open';
                        const fadeTime = isOpeningHit ? 0.08 : 0.03; 
                        
                        activeHH.gainNode.gain.setValueAtTime(activeHH.gainNode.gain.value, time);
                        activeHH.gainNode.gain.linearRampToValueAtTime(0, time + fadeTime);
                        activeHH.source.stop(time + fadeTime + 0.01);
                    } catch (e) {
                        console.error("Choke error:", e);
                    }
                }
                activeHH = { source: source, gainNode: gainNode };
            }

            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            source.start(time);
            return; // Success!
        } catch (e) {
            console.error("Buffer playback failed:", id, e);
        }
    }
    
    // FALLBACK: If buffer doesn't exist or failed, synthesize a simple tone
    // This helps diagnose if the issue is audio files or Web Audio API itself
    console.log("Using synthesized fallback for:", id);
    try {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        // Different frequencies for different drums
        if (id.includes('kick')) {
            oscillator.frequency.value = 60;
            gainNode.gain.setValueAtTime(0.5, time);
            gainNode.gain.exponentialRampToValueAtTime(0.01, time + 0.5);
        } else if (id.includes('snare')) {
            oscillator.frequency.value = 200;
            oscillator.type = 'triangle';
            gainNode.gain.setValueAtTime(0.3, time);
            gainNode.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
        } else if (id.includes('hihat')) {
            oscillator.frequency.value = 8000;
            oscillator.type = 'square';
            gainNode.gain.setValueAtTime(0.1, time);
            gainNode.gain.exponentialRampToValueAtTime(0.01, time + 0.1);
        } else if (id.includes('ride')) {
            oscillator.frequency.value = 3000;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.15, time);
            gainNode.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
        }
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start(time);
        oscillator.stop(time + 0.5);
    } catch (e) {
        console.error("Synthesized fallback failed:", e);
    }
}

function scheduleSounds(time) {
    const isTri = isTripletMode();
    const sub = isTri ? 3 : 4;
    const cymName = document.getElementById("cymbal-select").value;
    const footName = document.getElementById("foot-select").value;
    const el = getElement();
    const isAccent = document.getElementById("accent-mode").checked;
    
    const cymPat = (isTri ? tCym : sCym)[cymName];
    
    let footPat;
    if (isAccent && el === 'hi-hat') {
        footPat = getFootPatternForHiHatAccents(cymName, isTri);
    } else {
        footPat = (isTri ? tFoot : sFoot)[footName];
    }

    if (cymPat && cymPat[currentBeat % cymPat.length] === 1) {
        playDrum(el==='hi-hat'?'hihat':el, time, getAccentLogic(cymName, currentBeat, true));
    }
    const bIdx = Math.floor(currentBeat / sub) % 4;
    if (currentMid[bIdx] && currentMid[bIdx][currentBeat % sub] === 1) {
        playDrum(bIdx % 2 === 0 ? 'kick' : 'snare', time);
    }
    if (footPat && footPat[currentBeat % footPat.length] === 1) playDrum('hihat_foot', time, false);
}

function scheduler() {
    const tempo = document.getElementById('tempo-slider').value;
    const pocket = document.getElementById('pocket-slider').value / 100;
    const isTri = isTripletMode();
    const sps = (60.0 / tempo) / (isTri ? 3 : 4);

    while (nextNoteTime < audioCtx.currentTime + 0.15) {
        let subIdx = currentBeat % (isTri ? 3 : 4);
        let playTime = nextNoteTime;
        if (!isTri && (subIdx === 1 || subIdx === 3)) playTime += (sps * pocket);
        
        scheduleSounds(playTime);
        nextNoteTime += sps;
        currentBeat = (currentBeat + 1) % 48;
    }
    timerID = setTimeout(scheduler, 25);
}

// --- BEAT SAVE/LOAD FUNCTIONS ---
function getSavedBeats() {
    const saved = localStorage.getItem('vlackAttackBeats');
    return saved ? JSON.parse(saved) : {};
}

function saveBeats(beats) {
    localStorage.setItem('vlackAttackBeats', JSON.stringify(beats));
}

function getCurrentBeatData() {
    return {
        element: getElement(),
        cymbalPattern: document.getElementById('cymbal-select').value,
        footPattern: document.getElementById('foot-select').value,
        kickSnarePatterns: [...currentMid],
        tempo: document.getElementById('tempo-slider').value,
        pocket: document.getElementById('pocket-slider').value,
        tripletMode: isTripletMode(),
        accentMode: document.getElementById('accent-mode').checked,
        kit: document.getElementById('kit-select').value
    };
}

function loadBeatData(beatData) {
    // Set triplet/straight mode
    document.querySelectorAll('[data-mode]').forEach(btn => {
        btn.classList.remove('active');
        if ((beatData.tripletMode && btn.dataset.mode === 'triplet') ||
            (!beatData.tripletMode && btn.dataset.mode === 'straight')) {
            btn.classList.add('active');
        }
    });
    
    // Set element
    document.querySelectorAll('[data-element]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.element === beatData.element) {
            btn.classList.add('active');
        }
    });
    
    document.getElementById('accent-mode').checked = beatData.accentMode;
    updateMenus();
    document.getElementById('cymbal-select').value = beatData.cymbalPattern;
    document.getElementById('foot-select').value = beatData.footPattern;
    currentMid = [...beatData.kickSnarePatterns];
    document.getElementById('tempo-slider').value = beatData.tempo;
    document.getElementById('bpm-display').innerText = beatData.tempo;
    document.getElementById('pocket-slider').value = beatData.pocket;
    document.getElementById('pocket-display').innerText = beatData.pocket;
    document.getElementById('kit-select').value = beatData.kit;
    document.getElementById('pocket-slider').disabled = beatData.tripletMode;
    updateFootPatternForHiHatAccents();
    generate();
}

function updateSavedBeatsList() {
    const beats = getSavedBeats();
    const select = document.getElementById('saved-beats-select');
    select.innerHTML = '<option value="">-- Select a Beat --</option>';
    Object.keys(beats).sort().forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.text = name;
        select.add(option);
    });
}

function getNextBeatName() {
    const beats = getSavedBeats();
    let num = 1;
    while (beats[`Beat ${String(num).padStart(3, '0')}`]) {
        num++;
    }
    return `Beat ${String(num).padStart(3, '0')}`;
}

// --- EVENT HANDLERS ---
window.onload = () => {
    updateMenus();
    updateSavedBeatsList();
    
    // Triplet/Straight toggle
    document.querySelectorAll('[data-mode]').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateMenus();
            document.getElementById("pocket-slider").disabled = isTripletMode();
            document.getElementById('saved-beats-select').value = "";
            generate();
        };
    });
    
    // Element (Ride/Hi-Hat) toggle
    document.querySelectorAll('[data-element]').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('[data-element]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateFootPatternForHiHatAccents();
            generate();
        };
    });
    
    // Accent mode
    document.getElementById('accent-mode').onchange = () => {
        updateMenus();
        generate();
    };
    
    // Cymbal & Foot selects
    document.getElementById('cymbal-select').onchange = () => {
        updateFootPatternForHiHatAccents();
        generate();
    };
    
    document.getElementById('foot-select').onchange = () => {
        generate();
    };
    
    // Randomize button
    document.getElementById("gen-btn").onclick = () => {
        generate(true);
        document.getElementById('saved-beats-select').value = "";
    };
    
    // Play button
    document.getElementById('metro-btn').onclick = async function() {
        // Initialize AudioContext on first user interaction (required for iOS)
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            console.log("AudioContext created:", audioCtx.state);
        }
        
        // Always try to resume on iOS (it can get suspended)
        if (audioCtx.state !== 'running') {
            console.log("Attempting to resume from state:", audioCtx.state);
            await audioCtx.resume();
            console.log("AudioContext after resume:", audioCtx.state);
            await new Promise(r => setTimeout(r, 50));
        }
        
        isPlaying = !isPlaying;

        if (isPlaying) {
            const kit = document.getElementById('kit-select').value;
            if (Object.keys(buffers).length === 0) {
                this.textContent = "‚è≥ Loading...";
                this.disabled = true;
                try {
                    await loadKit(kit);
                    console.log("Kit loaded successfully, buffers:", Object.keys(buffers).length);
                } catch (e) {
                    console.error("Kit loading failed:", e);
                    // Continue anyway - fallback synth will play
                    console.log("Continuing with synthesized sounds");
                }
                this.disabled = false;
            }
            
            // Extra resume attempt right before playing
            if (audioCtx.state !== 'running') {
                await audioCtx.resume();
            }
            
            console.log("=== STARTING PLAYBACK ===");
            console.log("AudioContext state:", audioCtx.state);
            console.log("AudioContext time:", audioCtx.currentTime);
            console.log("Loaded buffers:", Object.keys(buffers));
            
            currentBeat = 0;
            nextNoteTime = audioCtx.currentTime + 0.1;
            this.textContent = "‚èπ Stop";
            scheduler();
        } else { 
            clearTimeout(timerID); 
            if (activeHH && activeHH.source) {
                try { activeHH.source.stop(); } catch(e) {}
            }
            activeHH = null; 
            this.textContent = "‚ñ∂ Play Beat"; 
        }
    };
    
    // Kit change
    document.getElementById('kit-select').addEventListener('change', async (e) => {
        // Only load kit if AudioContext has been initialized (user has clicked play at least once)
        if (!audioCtx) {
            console.log("AudioContext not initialized yet - kit will load on first play");
            // Clear buffers so it will reload on next play
            buffers = {};
            return;
        }
        
        const btn = document.getElementById('metro-btn');
        const wasPlaying = isPlaying;
        
        // Don't stop playback - just load new kit in background
        // The scheduler will automatically start using new buffers once they're loaded
        
        const oldText = btn.textContent;
        btn.textContent = wasPlaying ? "‚è≥ Loading..." : "‚è≥ Loading...";
        
        try {
            await loadKit(e.target.value);
            console.log("Kit loaded, playback continuing");
        } catch (error) {
            console.error("Failed to load kit:", error);
            alert("Failed to load kit. Please try again.");
        }
        
        // Restore button text based on playing state
        btn.textContent = wasPlaying ? "‚èπ Stop" : "‚ñ∂ Play Beat";
    });
    
    // Sliders
    document.getElementById('tempo-slider').oninput = (e) => document.getElementById('bpm-display').innerText = e.target.value;
    document.getElementById('pocket-slider').oninput = (e) => document.getElementById('pocket-display').innerText = e.target.value;
    
    // Auto-load beat when selected from dropdown
    document.getElementById("saved-beats-select").onchange = (e) => {
        if (!e.target.value) return;
        const beats = getSavedBeats();
        if (beats[e.target.value]) {
            loadBeatData(beats[e.target.value]);
        }
    };
    
    // Save button - show custom dialog
    document.getElementById("save-btn").onclick = () => {
        const defaultName = getNextBeatName();
        const input = document.getElementById('save-name-input');
        const dialog = document.getElementById('save-dialog');
        
        input.value = defaultName;
        dialog.classList.add('active');
        input.focus();
        input.select();
    };
    
    // Save dialog - Cancel
    document.getElementById('save-cancel').onclick = () => {
        document.getElementById('save-dialog').classList.remove('active');
    };
    
    // Save dialog - Confirm
    document.getElementById('save-confirm').onclick = () => {
        const name = document.getElementById('save-name-input').value.trim();
        
        if (!name) {
            alert('Please enter a name');
            return;
        }
        
        const beats = getSavedBeats();
        
        // Check if name already exists
        if (beats[name]) {
            if (!confirm(`A beat named "${name}" already exists. Overwrite it?`)) {
                return;
            }
        }
        
        // Save the beat
        beats[name] = getCurrentBeatData();
        saveBeats(beats);
        updateSavedBeatsList();
        document.getElementById('saved-beats-select').value = name;
        document.getElementById('save-dialog').classList.remove('active');
        
        console.log(`Beat saved as "${name}"`);
    };
    
    // Allow Enter key to save
    document.getElementById('save-name-input').onkeypress = (e) => {
        if (e.key === 'Enter') {
            document.getElementById('save-confirm').click();
        }
    };
    
    // Rename button
    document.getElementById("rename-btn").onclick = () => {
        const select = document.getElementById('saved-beats-select');
        if (!select.value) {
            alert('Please select a beat to rename');
            return;
        }
        const newName = prompt('Enter new name:', select.value);
        if (newName && newName !== select.value) {
            const beats = getSavedBeats();
            if (beats[newName]) {
                alert('A beat with that name already exists');
                return;
            }
            beats[newName] = beats[select.value];
            delete beats[select.value];
            saveBeats(beats);
            updateSavedBeatsList();
            select.value = newName;
        }
    };
    
    // Delete button
    document.getElementById("delete-btn").onclick = () => {
        const select = document.getElementById('saved-beats-select');
        if (!select.value) {
            alert('Please select a beat to delete');
            return;
        }
        if (confirm(`Delete "${select.value}"?`)) {
            const beats = getSavedBeats();
            delete beats[select.value];
            saveBeats(beats);
            updateSavedBeatsList();
        }
    };
    
    generate();
};
</script>

<!-- Register Service Worker for PWA -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(registration => {
        console.log('Service Worker registered successfully:', registration.scope);
      })
      .catch(error => {
        console.log('Service Worker registration failed:', error);
      });
  });
}
</script>

</body>
</html>

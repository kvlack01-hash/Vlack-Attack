<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vlack Attack v1.9.5 - Beam Force</title>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
        #output { background: white; margin: 20px auto; min-height: 400px; width: 900px; border: 1px solid #ddd; border-radius: 12px; }
        .controls { display: flex; justify-content: center; gap: 15px; padding: 20px; background: #f8f9fa; border-radius: 12px; flex-wrap: wrap; }
        .control-group { display: flex; flex-direction: column; align-items: flex-start; gap: 5px; }
        button, select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-weight: bold; }
        .label-text { font-size: 0.7rem; font-weight: bold; color: #666; text-transform: uppercase; }
        #gen-btn { background: #27ae60; color: white; border: none; }
    </style>
</head>
<body>

<div id="output"></div>

<div class="controls">
    <div class="control-group"><span class="label-text">Ride/HH</span><select id="el-sel"><option value="ride">Ride</option><option value="hi-hat">Hi-Hat</option></select></div>
    <div class="control-group"><span class="label-text">Ride Pattern</span><select id="cym-sel"></select></div>
    <div class="control-group"><span class="label-text">Left Foot</span><select id="foot-sel"></select></div>
    <button id="gen-btn">New Kick/Snare</button>
    <div style="display: flex; gap: 15px; align-items: center; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
        <label><input type="checkbox" id="trip-chk"> Triplet Mode</label>
        <label><input type="checkbox" id="acc-chk"> Accents</label>
    </div>
</div>

<script>
const VF = Vex.Flow;
let currentMid = [];

// DATA POOLS - Hardcoded inside to prevent scope loss
const POOLS = {
    sCym: { 'quarter notes': [1,0,0,0], 'up beats': [0,0,1,0], 'eighth notes': [1,0,1,0], '1 e &': [1,1,1,0] },
    tCym: { 'quarter notes': [1,0,0], 'shuffle': [1,0,1], 'swing': [1,0,0,1,0,1], '3:2 (down)': [1,0,1,0,1,0] },
    sFoot: { 'quarter notes': [1,0,0,0], '2 and 4': [0,0,0,0,1,0,0,0], 'eighth notes': [1,0,1,0] },
    tFoot: { 'quarter notes': [1,0,0], '2 and 4': [0,0,0,1,0,0], '3:2 (down)': [1,0,1,0,1,0] }
};

function updateMenus() {
    const isT = document.getElementById("trip-chk").checked;
    const cS = document.getElementById("cym-sel");
    const fS = document.getElementById("foot-sel");
    
    cS.innerHTML = ""; fS.innerHTML = "";
    
    const cymList = isT ? Object.keys(POOLS.tCym) : Object.keys(POOLS.sCym);
    const footList = isT ? Object.keys(POOLS.tFoot) : Object.keys(POOLS.sFoot);
    
    cymList.forEach(k => cS.add(new Option(k, k)));
    footList.forEach(k => fS.add(new Option(k, k)));
}

function generate(forceNew = false) {
    const div = document.getElementById("output");
    div.innerHTML = "";
    const isT = document.getElementById("trip-chk").checked;
    const sub = isT ? 3 : 4;

    const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
    renderer.resize(900, 400);
    const ctx = renderer.getContext();

    const stave = new VF.Stave(50, 40, 800).addClef("percussion").addTimeSignature("4/4").setContext(ctx).draw();

    // 1. Get Patterns
    const cymKey = document.getElementById("cym-sel").value;
    const footKey = document.getElementById("foot-sel").value;
    const cymPat = isT ? POOLS.tCym[cymKey] : POOLS.sCym[cymKey];
    
    // 2. Generate Kick/Snare Pool if empty
    if (forceNew || currentMid.length === 0) {
        currentMid = [];
        const pool = isT ? [[1,0,0], [0,1,0], [1,0,1]] : [[1,0,0,0], [0,1,0,0], [1,0,1,0]];
        for (let i = 0; i < 4; i++) currentMid.push(pool[Math.floor(Math.random() * pool.length)]);
    }

    const voiceTopNotes = [];
    const voiceBotNotes = [];
    const beams = [];

    // 3. Loop through 4 beats
    for (let b = 0; b < 4; b++) {
        let beatTop = [];
        let beatBot = [];

        for (let i = 0; i < sub; i++) {
            const index = b * sub + i;
            
            // TOP VOICE (Cymbals)
            const cHit = cymPat[index % cymPat.length] === 1;
            const tNote = new VF.StaveNote({
                keys: [cHit ? "G/5/x2" : "G/5/r"],
                duration: isT ? "8" : "16",
                stem_direction: 1
            });
            voiceTopNotes.push(tNote);
            beatTop.push(tNote);

            // BOTTOM VOICE (Kick/Snare)
            const mHit = currentMid[b][i % currentMid[b].length] === 1;
            const bNote = new VF.StaveNote({
                keys: [mHit ? (b % 2 === 0 ? "F/4" : "C/5") : "C/4/r"],
                duration: isT ? "8" : "16",
                stem_direction: -1
            });
            voiceBotNotes.push(bNote);
            beatBot.push(bNote);
        }

        // Create Beams for the beat (Filter out rests)
        const tHits = beatTop.filter(n => !n.isRest());
        if (tHits.length > 1) beams.push(new VF.Beam(tHits));

        const bHits = beatBot.filter(n => !n.isRest());
        if (bHits.length > 1) beams.push(new VF.Beam(bHits));
    }

    // 4. Formatting
    const v1 = new VF.Voice({ num_beats: 4, beat_value: 4 }).setStrict(false).addTickables(voiceTopNotes);
    const v2 = new VF.Voice({ num_beats: 4, beat_value: 4 }).setStrict(false).addTickables(voiceBotNotes);
    
    new VF.Formatter().joinVoices([v1, v2]).format([v1, v2], 700);

    v1.draw(ctx, stave);
    v2.draw(ctx, stave);
    beams.forEach(bm => bm.setContext(ctx).draw());
}

window.onload = () => {
    updateMenus();
    document.getElementById("trip-chk").onchange = () => { updateMenus(); generate(); };
    document.getElementById("cym-sel").onchange = () => generate();
    document.getElementById("foot-sel").onchange = () => generate();
    document.getElementById("el-sel").onchange = () => generate();
    document.getElementById("gen-btn").onclick = () => generate(true);
    generate();
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vlack Attack v1.9.4 - Restored</title>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
        .container { background: white; max-width: 1300px; margin: 0 auto; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        #output { background: white; margin: 20px 0; min-height: 520px; border: 1px solid #e1e4e8; border-radius: 12px; display: flex; justify-content: center; align-items: center; overflow-x: auto; }
        .controls { display: flex; justify-content: center; align-items: center; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #eee; flex-wrap: wrap; gap: 15px; }
        .control-group { display: flex; flex-direction: column; align-items: flex-start; gap: 5px; }
        button, select { padding: 10px 12px; cursor: pointer; border-radius: 8px; border: 1px solid #ced4da; background: white; font-weight: bold; }
        #gen-btn { background: #27ae60; color: white; border: none; padding: 12px 25px; }
        .label-text { font-size: 0.8rem; font-weight: bold; color: #777; text-transform: uppercase; }
        /* BEAMS RESTORED: Removed the .vf-flag display none rule */
    </style>
</head>
<body>

<div id="output"></div>

<div class="controls">
    <div class="control-group"><span class="label-text">Ride/Hi-Hat</span><select id="element-select"><option value="ride">Ride</option><option value="hi-hat">Hi-Hat</option></select></div>
    <div class="control-group"><span class="label-text">Ride Pattern</span><select id="cymbal-select"></select></div>
    <div class="control-group"><span class="label-text">Left Foot</span><select id="foot-select"></select></div>
    <button id="gen-btn">Randomize Kick/Snare</button>
    <div class="control-group"><span class="label-text">Tempo: <span id="bpm-display">92</span> BPM</span><input type="range" id="tempo-slider" min="40" max="220" value="92"></div>
    <div class="control-group"><span class="label-text">Pocket: <span id="pocket-display">0</span>%</span><input type="range" id="pocket-slider" min="0" max="30" value="0"></div>
    <div class="control-group"><span class="label-text">Drum Kit</span><select id="kit-select"><option value="studio">Studio</option><option value="jazz">Jazz</option><option value="lo-fi">Lo-Fi</option><option value="muffled">Muffled</option><option value="boomy">Boomy</option><option value="compressed">Compressed</option></select></div>
    <button id="metro-btn" style="background: #3498db; color: white;">Play Beat</button>
    <div style="display: flex; gap: 15px; align-items: center; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
        <label><input type="checkbox" id="triplet-mode"> Triplet Mode</label>
        <label><input type="checkbox" id="accent-mode"> Accents</label>
        <label><input type="checkbox" id="freeze-bottom"> Freeze Kick/Snare</label>
    </div>
</div>

<script>
const VF = Vex.Flow;
let buffers = {};
let audioCtx = null;
let isPlaying = false;
let nextNoteTime = 0.0;
let timerID = null;
let currentBeat = 0;
let currentMid = [];

const tCym = { 'quarter notes': [1,0,0], 'shuffle': [1,0,1], 'swing': [1,0,0,1,0,1], '3:2 (down)': [1,0,1,0,1,0], '3:2 (up)': [0,1,0,1,0,1], '3:4 v1': [1,1,1,0,1,1,1,0,1,1,1,0], '3:4 v2': [1,0,1,1,1,0,1,1,1,0,1,1], '3:4 v3': [0,1,1,1,0,1,1,1,0,1,1,1], 'shuffle ': [1,0,1], 'swing ': [1,0,0,1,0,1], '3:2 (down) shuffle ': [1,0,1,0,1,0], '3:2 (up) shuffle ': [0,1,0,1,0,1] };
const tFoot = { 'quarter notes': [1,0,0], '2 and 4': [0,0,0,1,0,0], '3:2 (down)': [1,0,1,0,1,0], '3:2 (up)': [0,1,0,1,0,1] };
const sCym = { 'quarter notes': [1,0,0,0], 'up beats': [0,0,1,0], 'eighth notes': [1,0,1,0], 'e a': [0,1,0,1], '1 e &': [1,1,1,0], 'e & a': [0,1,1,1], '1 & a': [1,0,1,1], '1 e a': [1,1,0,1], 'eighth notes (down)': [1,0,1,0], 'eighth notes (up)': [1,0,1,0], '1 e & ': [1,1,1,0], 'e & a ': [0,1,1,1], '1 & a ': [1,0,1,1], '1 e a ': [1,1,0,1] };
const sFoot = { 'quarter notes': [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0], '2 and 4': [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0], 'eighth notes': [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0] };
const tMidPool = [[1,0,0], [0,1,0], [1,0,1], [0,0,1], [1,1,0], [0,1,1]];
const sMidPool = [[1,0,0,0], [0,1,0,0], [0,0,1,0], [0,0,0,1], [1,0,1,0], [0,1,0,1], [1,1,0,0], [0,1,1,0], [0,0,1,1], [1,0,0,1]];

function getAccentLogic(p, i, h) { 
    if(!document.getElementById('accent-mode').checked || !h) return false; 
    const isTri = document.getElementById("triplet-mode").checked; 
    const check = p.toLowerCase();
    const pos = i % 4;
    if(isTri){
        const p3 = i % 3, p6 = i % 6;
        if(check.includes('shuffle')) return p3 === 0;
        if(check.includes('swing')) return p6 === 0;
        if(check.includes('3:2')) return (p6 === 0 || p6 === 4);
        return false;
    } else {
        if(check.includes('up')) return pos === 2;
        if(check.includes('down')) return pos === 0;
        if(check.includes('1 e &')) return pos === 2;
        return false;
    }
}

function updateMenus() { 
    const isT = document.getElementById("triplet-mode").checked;
    const isA = document.getElementById("accent-mode").checked;
    const cS = document.getElementById("cymbal-select");
    const fS = document.getElementById("foot-select");
    cS.innerHTML = ""; fS.innerHTML = "";
    let cL = isT ? (isA ? ['shuffle', 'swing', '3:2 (down) shuffle '] : ['quarter notes', 'shuffle', '3:2 (down)']) : (isA ? ['eighth notes (up)', 'eighth notes (down)', '1 e & '] : ['quarter notes', 'up beats', 'eighth notes']);
    let fL = isT ? ['quarter notes', '2 and 4', '3:2 (down)'] : ['quarter notes', '2 and 4', 'eighth notes'];
    cL.forEach(k => cS.add(new Option(k, k)));
    fL.forEach(k => fS.add(new Option(k, k)));
}

function createNote(v, d, h, b, a=false) { 
    const el = document.getElementById('element-select').value; 
    let k, s, rK, cD = d.replace('r',''), aR = !h||d.includes('r'); 
    if(v===0){ s=1; rK="B/5/r"; if(h) k=(el==='hi-hat')?"G/5/x2":(a?"G/5/d2":"G/5/x2"); } 
    else if(v===1){ k=(b%2===0)?"F/4":"C/5"; s=-1; rK="C/4/r"; } 
    else { k=h?"B/4/x2":"B/4/r"; s=-1; rK="B/4/r"; } 
    const n = new VF.StaveNote({keys:[h? (k||"G/5/x2"):rK], duration:cD+(aR?"r":""), stem_direction:s}); 
    if(h&&v===0&&a&&el==='hi-hat') n.addModifier(new VF.Articulation('ah').setPosition(3), 0); 
    if(cD.includes('d')) VF.Dot.buildAndAttach([n],{all:true}); 
    if(v===2) n.setKeyLine(0,2); 
    return n; 
}

function generate(f=false) { 
    const d = document.getElementById("output"); d.innerHTML = ""; 
    const isT = document.getElementById("triplet-mode").checked, sub = isT?3:4, tT = 4*sub;
    const r = new VF.Renderer(d, VF.Renderer.Backends.SVG); r.resize(1000, 500); 
    const ctx = r.getContext(), s1 = new VF.Stave(80, 40, 870).addClef("percussion").addTimeSignature("4/4").setContext(ctx).draw(), s2 = new VF.Stave(80, 200, 870); 
    [0,1,3,4].forEach(l=>s2.setConfigForLine(l,{visible:false})); s2.addClef("percussion").addTimeSignature("4/4").setContext(ctx).draw(); 
    new VF.StaveConnector(s1,s2).setType(VF.StaveConnector.type.BRACKET).setContext(ctx).draw(); 
    if(f||!document.getElementById("freeze-bottom").checked||currentMid.length===0){ 
        currentMid=[]; const p = isT?tMidPool:sMidPool; for(let i=0;i<4;i++) currentMid.push(p[Math.floor(Math.random()*p.length)]); 
    } 
    const vD=[[],[],[]], beams=[]; const cN = document.getElementById("cymbal-select").value, fN = document.getElementById("foot-select").value; 
    for(let b=0;b<4;b++){ 
        for(let vI=0;vI<3;vI++){ 
            let sl=[], pat=(vI===0)?(isT?tCym:sCym)[cN]:(vI===2?(isT?tFoot:sFoot)[fN]:currentMid[b]); 
            for(let i=0;i<sub;i++) sl.push(pat[(b*sub+i)%pat.length]); 
            let fLB=true; for(let k=1;k<sub;k++) if(sl[k]!==0) fLB=false; 
            if(fLB){ 
                let cDur=isT?"4d":"4", hit=sl[0]===1, acc=(vI===0)?getAccentLogic(cN,b*sub,hit):false; vD[vI].push(createNote(vI,cDur,hit,b,acc)); 
            } else { 
                let bN=[]; for(let i=0;i<sub;i++){ 
                    let h=sl[i]===1, acc=(vI===0)?getAccentLogic(cN,b*sub+i,h):false, fD=isT?"8":"16"; 
                    if(!h) fD+="r"; let n=createNote(vI,fD,h,b,acc); bN.push(n); vD[vI].push(n); 
                } 
                let nTB=bN.filter(n=>!n.isRest()); if(nTB.length>=2) beams.push(new VF.Beam(nTB)); 
            } 
        } 
    } 
    const voices = vD.map(n=>new VF.Voice({num_beats:tT, beat_value:isT?8:16}).setStrict(false).addTickables(n)); 
    new VF.Formatter().joinVoices([voices[0],voices[1]]).format([voices[0],voices[1]], 800); 
    new VF.Formatter().joinVoices([voices[2]]).format([voices[2]], 800); 
    voices[0].draw(ctx,s1); voices[1].draw(ctx,s1); voices[2].draw(ctx,s2); 
    beams.forEach(b=>b.setContext(ctx).draw()); 
}

async function loadKit(k) {
    const s = ['kick','snare','hihat','hihat_open','hihat_foot','ride','ride_bell']; 
    const nB = {};
    for (const name of s) {
        try {
            const r = await fetch(`samples/${k}/${name}.wav`);
            if(!r.ok) throw new Error();
            const aB = await r.arrayBuffer();
            nB[name] = await audioCtx.decodeAudioData(aB);
        } catch(e) { console.warn(`Missing sample: ${name}`); }
    }
    buffers = nB;
}

function playDrum(n, t, isAcc = false) {
    if(!audioCtx) return;
    let sN = n;
    if(isAcc){ if(n==='ride') sN='ride_bell'; if(n === 'hihat') sN = 'hihat_open'; }
    if(buffers[sN]){ 
        const s=audioCtx.createBufferSource(); s.buffer=buffers[sN]; s.connect(audioCtx.destination); s.start(t); return; 
    }
    const d = audioCtx.destination;
    if(n==='kick'){ 
        const o=audioCtx.createOscillator(), g=audioCtx.createGain(); 
        o.frequency.setValueAtTime(60,t); o.frequency.exponentialRampToValueAtTime(0.01,t+0.1); 
        g.gain.setValueAtTime(1.0,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1); 
        o.connect(g).connect(d); o.start(t); o.stop(t+0.1); 
    } else if(n==='snare'){
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type='square'; o.frequency.setValueAtTime(200,t);
        g.gain.setValueAtTime(0.3,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1);
        o.connect(g).connect(d); o.start(t); o.stop(t+0.1);
    }
}

function scheduler() {
    const tempo = document.getElementById('tempo-slider').value, pocket = document.getElementById('pocket-slider').value/100, isT = document.getElementById("triplet-mode").checked;
    const spb = 60.0/tempo, sps = isT?(spb/3):(spb/4);
    while (nextNoteTime < audioCtx.currentTime + 0.1) {
        let sI = currentBeat%(isT?3:4), aPT = nextNoteTime;
        if(!isT && (sI===1||sI===3)) aPT += (sps*pocket);
        const cN = document.getElementById("cymbal-select").value, el = document.getElementById('element-select').value, fN = document.getElementById("foot-select").value;
        const cP = (isT?tCym:sCym)[cN], fP = (isT?tFoot:sFoot)[fN];
        if(cP && cP[currentBeat%cP.length]===1) playDrum(el==='hi-hat'?'hihat':el, aPT, getAccentLogic(cN, currentBeat, true));
        const bI = Math.floor(currentBeat/(isT?3:4));
        if(currentMid[bI] && currentMid[bI][currentBeat%(isT?3:4)]===1) playDrum(bI%2===0?'kick':'snare', aPT);
        if(fP && fP[currentBeat%fP.length]===1) playDrum('hihat_foot', aPT);
        nextNoteTime += sps; currentBeat = (currentBeat+1)%(isT ? 12 : 16);
    }
    timerID = setTimeout(scheduler, 25);
}

window.onload = () => {
    updateMenus();
    document.querySelectorAll("select, input").forEach(el => {
        el.onchange = () => {
            if (el.id === "tempo-slider" || el.id === "pocket-slider") return;
            if (el.id === "triplet-mode" || el.id === "accent-mode") updateMenus();
            generate();
        };
    });
    document.getElementById("gen-btn").onclick = () => generate(true);
    document.getElementById('tempo-slider').oninput = (e) => document.getElementById('bpm-display').innerText = e.target.value;
    document.getElementById('pocket-slider').oninput = (e) => document.getElementById('pocket-display').innerText = e.target.value;
    document.getElementById('metro-btn').onclick = async function() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        if (Object.keys(buffers).length === 0) await loadKit(document.getElementById('kit-select').value);
        isPlaying = !isPlaying;
        if (isPlaying) { currentBeat = 0; nextNoteTime = audioCtx.currentTime; scheduler(); this.innerText = "Stop"; }
        else { clearTimeout(timerID); this.innerText = "Play Beat"; }
    };
    generate();
};
</script>
</body>
</html>
